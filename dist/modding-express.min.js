const{isArray:bF}=Array;const{assign:bG}=Object;(function(){let a=this;window.ModdingExpress=function(A){!game.custom.__MODDING_EXPRESS_DATA__&&(game.custom.__MODDING_EXPRESS_DATA__={loaders:new Map});let b=[];let{terminal:c,commands:d}=game.modding,{echo:_}=c;let f=function(C){_(`[[bg;#fff;]&lsqb;ModdingExpress&rsqb; ${C.replace(/\[/g,'&lsqb;').replace(/\]/g,'&rsqb;')}]`)};let g=function(_a){_(`[[bg;orange;]&lsqb;ModdingExpress&rsqb; ${_a.replace(/\[/g,'&lsqb;').replace(/\]/g,'&rsqb;')}]`)};let h=function(D,_b,..._c){if('function'===typeof D)try{D.call(_b,..._c)}catch(_A){return{success:!1,error:_A}}return{success:!0}};let B=function(E){return`${E.name||'Unknown'} (v${E.version||'1.0'}) by ${E.author||'Unknown'}`};let j=game.custom.__MODDING_EXPRESS_DATA__;let k=function(aA,_B,_C=null){if(!aA){!_C?g(`Failed to resolve middleware from ${_C}: Received value is blank.`):g('Failed to resolve a blank middleware.');throw ''}let _d=h(aA.load,aA,_B);if(!_d.success){g(`Failed to run load script for middleware ${B(aA)}, caught error:`);g(_d.error?.stack||'');throw ''}b.push(aA);f(`Loaded module: ${B(aA)}`);return aA.exports};var l=function(aB){aB=aB.trim();try{new URL(aB)}catch(e){aB=`https://github.com/bhpsngum/starblast-modding-express/raw/main/middleware/${aB}/index.js`}return aB};return{load:function(aC,aD,aE=!1){if('string'!==typeof aC)return k(aC,aD);aC=l(aC);let _D=j.loaders.get(aC);if(!aE&&_D)return k(_D,aD,aC);let _e=new XMLHttpRequest;_e.open('GET',aC,!1);try{_e.send()}catch(e){g(`Failed to resolve URL "${aC}": Fetch failed.`);return{}}try{_D=Function('game',_e.responseText)(game)}catch(e){g(`Failed to resolve URL "${aC}": Error when evaluating code.`);g(e.stack);return{}}j.loaders.set(aC,_D);try{return k(_D,aD,aC)}catch(e){return{}}},initialize:function(){let aF=this;for(let aI of b){let aJ=h(aI.initialize,aI,game);!aJ.success&&(g(`Failed to run initialization script for middleware ${B(aI)}, caught error:`),g(aJ.error?.stack||''));aI.options=aI.options||a.options;a.options={};if('object'===typeof aI.options)bG(a.options,aI.options);else{let aK=h(aI.options,aI,a.options);!aK.success&&(g(`Failed to load options for middleware ${B(aI)}, caught error:`),g(aK.error?.stack||''))}if(bF(aI.commands)){let i=0;for(let command of aI.commands){let aL=i++;if(!command)continue;if(!command.name){g(`Failed to load command index ${aL} in ${B(aI)}: Missing command name.`);continue}if('function'!==typeof command.handler){g(`Failed to load command '${command.name}' in ${B(aI)}: Missing command handler function.`);continue}d[command.name]=command.handler}}}mod.tick=mod.tick||a.tick;let aG=function(aM){for(let aN of b){let aO=!1;let aP=h(aN.tick,a,aM,aN,function(){aO=!0});!aP.success&&(g(`Failed to run tick script for middleware ${B(aN)}, caught error:`),g(aP.error?.stack||''));if(aO)break}h(aF.tick,a,aM);for(let ship of aM.ships)for(let aQ of b){let aR=!1;let aS=h(aQ.playerTick,aQ,ship,aM,aQ,function(){aR=!0});!aS.success&&(g(`Failed to run player tick script for middleware ${B(aQ)}, caught error:`),g(aS.error?.stack||''));if(aR)break}};a.tick=aT=>{aG(aT);a.tick!==aG&&(a.tick=aG)};mod.event=mod.event||a.event;let aH=function(aU,aV){for(let aX of b){let aY=!1;let aZ=h(aX.event,aX,aU,aV,aX,function(){aY=!0});!aZ.success&&(g(`Failed to run event script for middleware ${B(aX)}, caught error:`),g(aZ.error?.stack||''));if(aY)break}h(aF.event,a,aU,aV);let aW=aU.killer||aU.ship;if(aW)for(let bA of b){let bB=!1;let bC=h(bA.playerEvent,a,aW,aU,aV,bA,function(){bB=!0});!bC.success&&(g(`Failed to run player event script for middleware ${B(bA)}, caught error:`),g(bC.error?.stack||''));if(bB)break}};a.event=(bD,bE)=>{aH(bD,bE);a.event!==aH&&(a.event=aH)}}}}}).call(this);
