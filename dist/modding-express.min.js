const{isArray:a}=Array;const ModdingExpress=(function(){let A=this;return function(_){!game.custom.__MODDING_EXPRESS_DATA__&&(game.custom.__MODDING_EXPRESS_DATA__={loaders:new Map});let B=[];let{terminal:C,commands:d}=game.modding,{echo:E}=C;let f=function(_a){E(`[[bg;#fff;]&lsqb;ModdingExpress&rsqb; ${_a.replace(/\[/g,'&lsqb;').replace(/\]/g,'&rsqb;')}]`)};let g=function(D){E(`[[bg;orange;]&lsqb;ModdingExpress&rsqb; ${D.replace(/\[/g,'&lsqb;').replace(/\]/g,'&rsqb;')}]`)};let h=function(_A,_b,..._c){if('function'===typeof _A)try{_A.call(_b,..._c)}catch(aA){return{success:!1,error:aA}}return{success:!0}};let I=function(aB){return`${aB.name||'Unknown'} (v${aB.version||'1.0'}) by ${aB.author||'Unknown'}`};let j=game.custom.__MODDING_EXPRESS_DATA__;let k=function(aC,_B,_C=null){if(!aC){!_C?g(`Failed to resolve middleware from ${_C}: Received value is blank.`):g('Failed to resolve a blank middleware.');throw ''}let _d=h(aC.load,aC,_B);if(!_d.success){g(`Failed to run load script for middleware ${I(aC)}, caught error:`);g(_d.error?.stack||'');throw ''}B.push(aC);f(`Loaded module: ${I(aC)}`);return aC.exports};const l=function(aD){aD=aD.trim();try{new URL(aD)}catch(e){aD=`https://raw.githubusercontent.com/Bhpsngum/starblast-modding-express/refs/heads/main/middleware/${aD}/index.js`}return aD};return{load:function(aE,aF,aG=!1){if('string'!==typeof aE)return k(aE,aF);aE=l(aE);let _D=j.loaders.get(aE);if(!aG&&_D)return k(_D,aF,aE);let _e=new XMLHttpRequest;_e.open('GET',aE,!1);try{_e.send()}catch(e){g(`Failed to resolve URL "${aE}": Fetch failed.`);return{}}try{_D=Function('game',_e.responseText)(game)}catch(e){g(`Failed to resolve URL "${aE}": Error when evaluating code.`);g(e.stack);return{}}j.loaders.set(aE,_D);try{return k(_D,aF,aE)}catch(e){return{}}},initialize:function(){let aH=this;for(let aK of B){let aL=h(aK.initialize,aK,game);!aL.success&&(g(`Failed to run initialization script for middleware ${I(aK)}, caught error:`),g(aL.error?.stack||''));aK.options=aK.options||A.options;A.options={};if('object'===typeof aK.options)b(A.options,aK.options);else{let aM=h(aK.options,aK,A.options);!aM.success&&(g(`Failed to load options for middleware ${I(aK)}, caught error:`),g(aM.error?.stack||''))}if(a(aK.commands)){let i=0;for(let command of aK.commands){let aN=i++;if(!command)continue;if(!command.name){g(`Failed to load command index ${aN} in ${I(aK)}: Missing command name.`);continue}if('function'!==typeof command.handler){g(`Failed to load command '${command.name}' in ${I(aK)}: Missing command handler function.`);continue}d[command.name]=command.handler}}}mod.tick=mod.tick||A.tick;let aI=function(aO){for(let aP of B){let aQ=!1;let aR=h(aP.tick,A,aO,aP,function(){aQ=!0});!aR.success&&(g(`Failed to run tick script for middleware ${I(aP)}, caught error:`),g(aR.error?.stack||''));if(aQ)break}h(aH.tick,A,aO);for(let ship of aO.ships){for(let aT of B){let aU=!1;let aV=h(aT.playerTick,aT,ship,aO,aT,function(){aU=!0});!aV.success&&(g(`Failed to run player tick script for middleware ${I(aT)}, caught error:`),g(aV.error?.stack||''));if(aU)break}let aS=h(aH.playerTick,A,ship,aO);!aS.success&&(g(`Caught error while running custom player tick script:`),g(aS.error?.stack||''))}};A.tick=aW=>{aI(aW);A.tick!==aI&&(A.tick=aI)};mod.event=mod.event||A.event;let aJ=function(aX,aY){for(let bA of B){let bB=!1;let bC=h(bA.event,bA,aX,aY,bA,function(){bB=!0});!bC.success&&(g(`Failed to run event script for middleware ${I(bA)}, caught error:`),g(bC.error?.stack||''));if(bB)break}h(aH.event,A,aX,aY);let aZ=aX.killer||aX.ship;if(aZ){for(let bE of B){let bF=!1;let bG=h(bE.playerEvent,A,aZ,aX,aY,bE,function(){bF=!0});!bG.success&&(g(`Failed to run player event script for middleware ${I(bE)}, caught error:`),g(bG.error?.stack||''));if(bF)break}let bD=h(aH.playerEvent,A,aZ,aX,aY);!bD.success&&(g(`Caught error while running custom player event script:`),g(bD.error?.stack||''))}};A.event=(bH,bI)=>{aJ(bH,bI);A.event!==aJ&&(A.event=aJ)}}}}}).call(this),{assign:b}=Object;
