const{isArray:a}=Array;const{assign:b}=Object;const ModdingExpress=(function(){let A=this;return _=>{!game.custom.__MODDING_EXPRESS_DATA__&&(game.custom.__MODDING_EXPRESS_DATA__={loaders:new Map});let B=new Map([['tick',[]],['event',[]],['playerTick',[]],['playerEvent',[]]]);let{terminal:C,commands:D}=game.modding,{echo:E}=C;let f=A.tick,g=A.event,h=A.options||{};let I=function(_a){for(let _A of B.get('tick')){let aA=!1;let _B=m(_A,A,_a,function(){aA=!0});!_B.success&&(l(`Failed to run tick script, caught error:`),l(_B.error?.stack||''));if(aA)break}for(let ship of _a.ships)for(let aB of B.get('playerTick')){let aC=!1;let aD=m(aB,A,ship,_a,function(){aC=!0});!aD.success&&(l(`Failed to run player tick script, caught error:`),l(aD.error?.stack||''));if(aC)break}let _b=m(f,A,_a);!_b.success&&(l(`Failed to run this.tick script, caught error:`),l(_b.error?.stack||''))};let j=function(aE,aF){for(let aG of B.get('event')){let aH=!1;let aI=m(aG,A,aE,aF,function(){aH=!0});!aI.success&&(l(`Failed to run event script, caught error:`),l(aI.error?.stack||''));if(aH)break}let _c=m(g,A,aE,aF);!_c.success&&(l(`Failed to run this.event script, caught error:`),l(_c.error?.stack||''));let _d=aE.killer||aE.ship;if(_d)for(let aJ of B.get('playerEvent')){let aK=!1;let aL=m(aJ,A,_d,aE,aF,function(){aK=!0});!aL.success&&(l(`Failed to run player event script, caught error:`),l(aL.error?.stack||''));if(aK)break}};try{c(A,'tick',{get:function(){return I},set:function(aM){f=aM}})}catch(e){l('Fatal: Failed to overwrite tick function.');return}try{c(A,'event',{get:function(){return j},set:function(aN){g=aN}})}catch(e){l('Fatal: Failed to overwrite event function.');return}try{c(A,'options',{get:function(){return h},set:function(aO){b(h,aO)}})}catch(e){l('Fatal: Failed to overwrite options.');return}let k=function(aP){E(`[[bg;#fff;]&lsqb;ModdingExpress&rsqb; ${aP.replace(/\[/g,'&lsqb;').replace(/\]/g,'&rsqb;')}]`)};let l=function(aQ){E(`[[bg;orange;]&lsqb;ModdingExpress&rsqb; ${aQ.replace(/\[/g,'&lsqb;').replace(/\]/g,'&rsqb;')}]`)};let m=function(aR,aS,..._C){if('function'===typeof aR)try{aR.call(aS,..._C)}catch(aT){return{success:!1,error:aT}}return{success:!0}};let n=function(aU){return`${aU.name||'Unknown'} (v${aU.version||'1.0'}) by ${aU.author||'Unknown'}`};let o=game.custom.__MODDING_EXPRESS_DATA__;let p=function(aV,aW,aX=null){if(!aV){aX?l(`Failed to resolve middleware from ${aX}: Received value is blank.`):l('Failed to resolve a blank middleware.');throw ''}let _D=m(aV.load,aV,r,aW);if(!_D.success){l(`Failed to run load script for middleware ${n(aV)}, caught error:`);l(_D.error?.stack||'');throw ''}if(a(aV.commands)){let i=0;for(let command of aV.commands){let aY=i++;if(!command)continue;if(!command.name){l(`Failed to load command index ${aY} in ${n(aV)}: Missing command name.`);continue}if('function'!==typeof command.handler){l(`Failed to load command '${command.name}' in ${n(aV)}: Missing command handler function.`);continue}D[command.name]=command.handler}}k(`Loaded module: ${n(aV)}`);return aV.exports};const q=function(aZ){aZ=aZ.trim();try{new URL(aZ)}catch(e){aZ=`https://raw.githubusercontent.com/Bhpsngum/starblast-modding-express/refs/heads/main/middleware/${aZ}/index.js`}return aZ};let r={unbind:function(bA,...bB){let bC=B.get(bA);if(!bC)return;if(!bB.length){bC.length=0;return}for(let bD of bB){let bE=bC.indexOf(bD);bE>-1&&bC.splice(bE,1)}},bind:function(bF,...bG){let bH=B.get(bF);if(!bH)return;bH.push(...bG)},replace:function(bI,bJ,...bK){let bL=B.get(bI);if(!bL)return;let _e=bL.indexOf(bJ);_e>-1?bL.splice(_e,1,...bK):bL.push(...bK)},load:function(bM,bN,bO=!1){if('string'!==typeof bM)return p(bM,bN);bM=q(bM);let bP=o.loaders.get(bM);if(!bO&&bP)return p(bP,bN,bM);let _E=new XMLHttpRequest;_E.open('GET',bM,!1);try{_E.send()}catch(e){l(`Failed to resolve URL "${bM}": Fetch failed.`);return{}}try{bP=Function('game',_E.responseText)(game)}catch(e){l(`Failed to resolve URL "${bM}": Error when evaluating code.`);l(e.stack);return{}}o.loaders.set(bM,bP);try{return p(bP,bN,bM)}catch(e){return{}}}};Object.defineProperties(r,{options:{configurable:!1,enumerable:!0,writable:!1,value:h},sourceURLs:{get:function(){return o.loaders.keys()}}});return r}}).call(this),{defineProperty:c}=Object;
