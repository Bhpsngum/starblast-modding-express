const{isArray:a}=Array;const ModdingExpress=(function(){let A=this;return function(_){!game.custom.__MODDING_EXPRESS_DATA__&&(game.custom.__MODDING_EXPRESS_DATA__={loaders:new Map});let B=new Map([['tick',[]],['event',[]],['playerTick',[]],['playerEvent',[]]]);let{terminal:C,commands:d}=game.modding,{echo:E}=C;let f=function(_a){E(`[[bg;#fff;]&lsqb;ModdingExpress&rsqb; ${_a.replace(/\[/g,'&lsqb;').replace(/\]/g,'&rsqb;')}]`)};let g=function(D){E(`[[bg;orange;]&lsqb;ModdingExpress&rsqb; ${D.replace(/\[/g,'&lsqb;').replace(/\]/g,'&rsqb;')}]`)};let h=function(_A,_b,..._c){if('function'===typeof _A)try{_A.call(_b,..._c)}catch(aA){return{success:!1,error:aA}}return{success:!0}};let I=function(aB){return`${aB.name||'Unknown'} (v${aB.version||'1.0'}) by ${aB.author||'Unknown'}`};let j=game.custom.__MODDING_EXPRESS_DATA__;let k=function(aC,_B,_C=null){if(!aC){_C?g(`Failed to resolve middleware from ${_C}: Received value is blank.`):g('Failed to resolve a blank middleware.');throw ''}let _d=h(aC.load,aC,m,_B);if(!_d.success){g(`Failed to run load script for middleware ${I(aC)}, caught error:`);g(_d.error?.stack||'');throw ''}f(`Loaded module: ${I(aC)}`);return aC.exports};const l=function(aD){aD=aD.trim();try{new URL(aD)}catch(e){aD=`https://raw.githubusercontent.com/Bhpsngum/starblast-modding-express/refs/heads/main/middleware/${aD}/index.js`}return aD};let m={unbind:function(aE,...aF){let aG=B.get(aE);if(!aG)return;for(let aH of aF){let aI=aG.indexOf(aH);aI>-1&&aG.splice(aI,1)}},bind:function(aJ,...aK){let aL=B.get(aJ);if(!aL)return;aL.push(...aK)},load:function(aM,aN,aO=!1){if('string'!==typeof aM)return k(aM,aN);aM=l(aM);let _D=j.loaders.get(aM);if(!aO&&_D)return k(_D,aN,aM);let _e=new XMLHttpRequest;_e.open('GET',aM,!1);try{_e.send()}catch(e){g(`Failed to resolve URL "${aM}": Fetch failed.`);return{}}try{_D=Function('game',_e.responseText)(game)}catch(e){g(`Failed to resolve URL "${aM}": Error when evaluating code.`);g(e.stack);return{}}j.loaders.set(aM,_D);try{return k(_D,aN,aM)}catch(e){return{}}},initialize:function(){let aP=this;for(let aS of B){let aT=h(aS.initialize,aS,aP,game);!aT.success&&(g(`Failed to run initialization script for middleware ${I(aS)}, caught error:`),g(aT.error?.stack||''));aS.options=aS.options||A.options;A.options={};if('object'===typeof aS.options)b(A.options,aS.options);else{let aU=h(aS.options,aS,A.options);!aU.success&&(g(`Failed to load options for middleware ${I(aS)}, caught error:`),g(aU.error?.stack||''))}if(a(aS.commands)){let i=0;for(let command of aS.commands){let aV=i++;if(!command)continue;if(!command.name){g(`Failed to load command index ${aV} in ${I(aS)}: Missing command name.`);continue}if('function'!==typeof command.handler){g(`Failed to load command '${command.name}' in ${I(aS)}: Missing command handler function.`);continue}d[command.name]=command.handler}}}A.tick&&this.bind('tick',A.tick);let aQ=function(aW){for(let aX of B.get('tick')){let aY=!1;let aZ=h(aX,A,aW,function(){aY=!0});!aZ.success&&(g(`Failed to run tick script, caught error:`),g(aZ.error?.stack||''));if(aY)break}for(let ship of aW.ships)for(let bA of B.get('playerTick')){let bB=!1;let bC=h(bA,A,ship,aW,function(){bB=!0});!bC.success&&(g(`Failed to run player tick script, caught error:`),g(bC.error?.stack||''));if(bB)break}};A.tick=bD=>{aQ(bD);A.tick!==aQ&&(A.tick=aQ)};A.event&&this.bind('event',A.event);let aR=function(bE,bF){for(let bH of B.get('event')){let bI=!1;let bJ=h(bH,A,bE,bF,function(){bI=!0});!bJ.success&&(g(`Failed to run event script, caught error:`),g(bJ.error?.stack||''));if(bI)break}let bG=bE.killer||bE.ship;if(bG)for(let bK of B.get('playerEvent')){let bL=!1;let bM=h(bK,A,bG,bE,bF,function(){bL=!0});!bM.success&&(g(`Failed to run player event script, caught error:`),g(bM.error?.stack||''));if(bL)break}};A.event=(bN,bO)=>{aR(bN,bO);A.event!==aR&&(A.event=aR)}}};return m}}).call(this),{assign:b}=Object;
